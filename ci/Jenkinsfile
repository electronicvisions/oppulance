@Library("jenlib") _

slurmTestResources = [["partition": "dls", "gres": "B291656", "powercycle": ""],
                      ["partition": "dls", "gres": "B291673", "powercycle": ""],
                      ["partition": "cube", "wafer": 62, "fpga-without-aout": 3]]
configureOptions = ["", "--enable-stack-protector", "--enable-stack-redzone", "--enable-stack-protector --enable-stack-redzone"]
buildProfiles = ["", "debug", "release"]

timestamps {
	try {
		runOnSlave(label: "frontend") {
			cleanWs()
		}

		stage("Toolchain Creation") {
			inSingularity(app: "visionary-dls") {
				runOnSlave(label: "frontend") {
					dir("ppu") {
						checkout scm
					}
					wafSetup(projects: ["binutils-gdb@visionary",
					                    "gcc@visionary",
					                    "newlib@master"],
					         noExtraStage: true)
					jesh "bash gcc/ci/00_download_prerequisites.sh"
				}

				onSlurmResource(partition: "jenkins", "cpus-per-task": "8") {
					jesh "bash binutils-gdb/ci/00_build_install.sh"
					jesh "bash gcc/ci/01_build_install_freestanding.sh"
					jesh "bash newlib/ci/00_build_install.sh"
					jesh "bash ppu/ci/00_build_install_libstdc++.sh"
				}
			}
		}

		withWaf() {
			for (String buildProfile in buildProfiles) {
				String buildProfileOption = buildProfile.length() ? "--build-profile=${buildProfile}" : ""
				stage("Toolchain Verification Setup: build-profile=${buildProfile}") {
					inSingularity(app: "visionary-dls") {
						runOnSlave(label: "frontend") {
								wafSetup(projects: ["libnux"],
								         setupOptions: "--clone-depth=1 " +
								                       "${buildProfileOption}",
								         noExtraStage: true)
						}
					}
				}

				for (String configureOption in configureOptions) {
					String runString = "build-profile: ${buildProfile}, options: ${configureOption}"
					stage("Toolchain Verification: ${runString}") {
						onSlurmResource(partition: "jenkins", "cpus-per-task": "8") {
							withModules(modules: ["xilinx/143"]) {
								withEnv(["SINGULARITYENV_PREPEND_PATH+INSTALL=$WORKSPACE/install/bin",
								         "SINGULARITYENV_LD_LIBRARY_PATH+INSTALL=$WORKSPACE/install/lib"]) {
									inSingularity(app: "visionary-dls") {
										jesh "waf configure " +
										     "${configureOption} " +
										     "--test-timeout=240 " +
										     "install --test-execnone" +
										     "|& tee build_dls_\"${runString}\".log"
									}
								}
							}
						}

						for (testResource in slurmTestResources) {
							onSlurmResource(testResource) {
								withEnv(["SINGULARITYENV_PREPEND_PATH+INSTALL=$WORKSPACE/install/bin",
								         "SINGULARITYENV_LD_LIBRARY_PATH+INSTALL=$WORKSPACE/install/lib"]) {
									withModules(modules: ["xilinx/143"]) {
										inSingularity(app: "visionary-dls") {
											jesh "waf install -j1 --test-execall"
										}
									}
								}
							}
							runOnSlave(label: "frontend") {
								step([$class       : 'XUnitBuilder',
								      thresholdMode: 1,
								      thresholds   : [[$class           : 'FailedThreshold',
								                       unstableThreshold: '0'],
								      ],
								      tools        : [[$class               : 'GoogleTestType',
								                       deleteOutputFiles    : true,
								                       failIfNotNew         : true,
								                       pattern              : "build/test_results/**/*.xml",
								                       skipNoTestFiles      : false,
								                       stopProcessingIfError: true]
								      ]
								])
								jesh "rm -rf build/test_results"
							}
						}
					}
				}
			}
		}

		stage("Evaluate Compiler Warnings") {
			runOnSlave(label: "frontend") {
				warnings canComputeNew: false,
				         canRunOnFailed: true,
				         categoriesPattern: '',
				         parserConfigurations: [[parserName: 'GNU C Compiler 4 (gcc)', pattern: 'build_dls_*.log']],
				         defaultEncoding: '',
				         excludePattern: '*/python2.7/*',
				         healthy: '',
				         includePattern: '',
				         messagesPattern: '',
				         unHealthy: '',
				         unstableTotalAll: '0',
				         unstableTotalHigh: '0',
				         unstableTotalLow: '0',
				         unstableTotalNormal: '0'
			}
		}

		stage("Deployment") {
			if (env.GERRIT_EVENT_TYPE == "change-merged") {
				if (currentBuild.currentResult == "SUCCESS") {
					runOnSlave(label: "frontend") {
						inSingularity(app: "visionary-dls") {
							deployModule([name: "ppu-toolchain", source: "install"])
						}
					}
				} else {
					echo "Deployment skipped: Unstable build."
				}
			} else {
				echo "Deployment skipped: Build was not triggered by a merge event."
			}
		}
	} catch (Throwable t) {
		notifyFailure(mattermostChannel: "#dls-software")
		throw t
	} finally {
		runOnSlave(label: "frontend") {
			// Always clean the workspace
			cleanWs()
		}
	}

	// Some Jenkins steps fail a build without raising (e.g. archiveArtifacts)
	if (currentBuild.currentResult != "SUCCESS") {
		notifyFailure(mattermostChannel: "#dls-software")
	}
}
